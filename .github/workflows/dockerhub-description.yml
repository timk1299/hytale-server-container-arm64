name: üì¶ Sync Documentation to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - README.md
      - .github/workflows/dockerhub-description.yml
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: write
  administration: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: üìè Get Actual Image Size
        id: get_info
        run: |
          # 1. Fetch metadata
          JSON_DATA=$(curl -s "https://hub.docker.com/v2/repositories/deinfreu/hytale-server/tags/experimental-alpine-liberica")
          
          # 2. Extract size and convert to MB
          SIZE_BYTES=$(echo $JSON_DATA | jq -r '.full_size')
          SIZE_MB=$(echo "scale=1; $SIZE_BYTES / 1048576" | bc)
          
          # 3. Create the strings
          # Long version for GitHub
          GH_DESC="üöÄ Hytale Docker Server üì¶ ${SIZE_MB}MB (Alpine/Liberica) ‚Ä¢ Secure non-root execution ‚Ä¢ Fast QUIC/UDP optimization ‚Ä¢ Built-in Production & Debug diagnostics ‚Ä¢ Pterodactyl supported ‚úÖ"
          
          # Short version for Docker Hub (Optimized 100 chars)
          DH_DESC="üì¶ ${SIZE_MB}MB (Alpine/Liberica) ‚Ä¢ Non-root ‚Ä¢ QUIC Enabled ‚Ä¢ Prod & Debug ‚Ä¢ Pterodactyl ‚úÖ"
          
          # 4. EXPORT THEM PROPERLY
          echo "GITHUB_DESC=$GH_DESC" >> $GITHUB_OUTPUT
          echo "DOCKER_DESC=$DH_DESC" >> $GITHUB_OUTPUT

      - name: üêô Update GitHub Repository Description
        run: |
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }} \
            -d "{\"description\":\"${{ steps.get_info.outputs.GITHUB_DESC }}\"}"

      - name: üìù Update Docker Hub README & Short Description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          repository: hytale-server
          short-description: ${{ steps.get_info.outputs.DOCKER_DESC }}
          enable-url-completion: true